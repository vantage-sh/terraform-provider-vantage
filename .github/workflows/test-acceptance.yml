name: Acceptance Tests

on:
  # Use pull_request_target to access secrets for fork PRs
  # IMPORTANT: This workflow must NOT checkout or execute PR code
  pull_request_target:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

concurrency:
  group: test-acceptance-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  test-acceptance:
    name: Dispatch
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Vantage-sh Workflow
        env:
          GH_TOKEN: ${{ secrets.API_REPO_DISPATCH_PAT }}
          EVENT_NAME: ${{ github.event_name }}
          PUSH_SHA: ${{ github.sha }}
          PUSH_ACTOR: ${{ github.actor }}
          PR_NUMBER_RAW: ${{ github.event.pull_request.number }}
          PR_SHA: ${{ github.event.pull_request.head.sha }}
          PR_LOGIN: ${{ github.event.pull_request.user.login }}
        run: |
          # Determine event type and set variables accordingly
          if [[ "$EVENT_NAME" == "push" ]]; then
            PR_NUMBER=0
            SHA="$PUSH_SHA"
            PR_AUTHOR="$PUSH_ACTOR"
            echo "Push to main by $PR_AUTHOR"
          else
            PR_NUMBER="$PR_NUMBER_RAW"
            SHA="$PR_SHA"
            PR_AUTHOR="$PR_LOGIN"
            echo "PR #$PR_NUMBER by $PR_AUTHOR"
          fi

          # Send repository_dispatch to trigger acceptance tests
          # IMPORTANT: Only send metadata, never checkout or execute PR code here
          curl -sfS -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/vantage-sh/core/dispatches" \
            -d "$(jq -n \
              --argjson pr_number "$PR_NUMBER" \
              --arg sha "$SHA" \
              --arg pr_author "$PR_AUTHOR" \
              '{
                event_type: "terraform-provider-test",
                client_payload: {
                  pr_number: $pr_number,
                  sha: $sha,
                  pr_author: $pr_author
                }
              }')"

          echo "Triggered acceptance tests"
          echo "Commit: $SHA"
